version: '3.8'

networks:
  scavenger-net:
    name: scavenger-net
    driver: bridge

volumes:
  mongo-data:
    name: scavenger-mongo-data
    driver: local

services:
  # ==================== MongoDB ====================
  mongo:
    image: mongo:8.0
    container_name: mongo-scavenger
    networks:
      - scavenger-net
    volumes:
      - mongo-data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=scavengerhunt
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ==================== Spring Boot ====================
  spring-backend:
    image: grexrr/spring-backend:demo
    container_name: spring-backend
    networks:
      - scavenger-net
    ports:
      - "8443:8080"
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongo-scavenger:27017/scavengerhunt
      - JAVA_TOOL_OPTIONS=-Dpuzzle.agent.url=http://puzzle-agent:5000 -Dlandmark.processor.url=http://landmark-processor:5000
    depends_on:
      - mongo
      - puzzle-agent
      - landmark-processor
    restart: unless-stopped

  # ==================== PuzzleAgent(Flask) ====================
  puzzle-agent:
    image: grexrr/puzzle-agent:demo
    container_name: puzzle-agent
    networks:
      - scavenger-net
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MONGO_URL=mongodb://mongo-scavenger:27017
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
    depends_on:
      - mongo
    restart: unless-stopped

  # ==================== LandmarkProcessor (Flask) ====================
  landmark-processor:
    image: grexrr/landmark-processor:demo
    container_name: landmark-processor
    networks:
      - scavenger-net
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MONGO_URL=mongodb://mongo-scavenger:27017
      - MONGO_DB=scavengerhunt
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
    depends_on:
      - mongo
    restart: unless-stopped
